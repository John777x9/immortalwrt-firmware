name: Build ImmortalWrt Firmware

on:
  schedule:
    - cron: '0 0 * * 1'

  workflow_dispatch:
    inputs:
      device:
        description: 'ç¼–è¯‘è®¾å¤‡'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - x86-64
          - rax3000m
          - mt3000
      clean:
        description: 'å…¨æ–°ç¼–è¯‘ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: false
        type: boolean

  push:
    paths:
      - 'devices/*.conf'
      - 'scripts/**'
      - 'files/**'
      - 'patches/**'

env:
  TZ: Asia/Shanghai

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      date: ${{ steps.date.outputs.date }}
    steps:
      - uses: actions/checkout@v4

      - id: date
        run: echo "date=$(date +%Y.%m.%d)" >> $GITHUB_OUTPUT

      - id: set-matrix
        run: |
          INPUT="${{ inputs.device }}"
          if [ "$INPUT" = "all" ] || [ -z "$INPUT" ]; then
            DEVICES=$(ls devices/*.conf | sed 's|devices/||;s|\.conf||' | jq -R . | jq -sc .)
          else
            DEVICES="[\"${INPUT}\"]"
          fi
          echo "matrix={\"device\":$DEVICES}" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Building devices: $DEVICES"

  build:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“‹ è¯»å–è®¾å¤‡é…ç½®
        id: config
        run: |
          source devices/${{ matrix.device }}.conf
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "target=$TARGET" >> $GITHUB_OUTPUT
          echo "subtarget=$SUBTARGET" >> $GITHUB_OUTPUT
          echo "device=$DEVICE" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ é‡Šæ”¾ç£ç›˜ç©ºé—´
        run: |
          echo "Before cleanup:"
          df -h /
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/share/swift /usr/local/graalvm /usr/local/.ghcup \
            /usr/local/share/boost /opt/hostedtoolcache/CodeQL
          sudo apt-get purge -y azure-cli google-cloud-cli microsoft-edge-stable \
            google-chrome-stable firefox powershell mono-devel 2>/dev/null || true
          sudo apt-get autoremove -y && sudo apt-get clean
          echo "After cleanup:"
          df -h /

      - name: ðŸ’¿ åˆ›å»º Swapï¼ˆé˜²æ­¢å†…å­˜ä¸è¶³ï¼‰
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "Swap enabled:"
          free -h

      - name: ðŸ”§ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk \
            gettext gcc-multilib g++-multilib git gnutls-dev gperf haveged help2man intltool \
            jq lib32gcc-s1 libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev \
            libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp nano ninja-build p7zip \
            p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils \
            rsync scons squashfs-tools subversion swig texinfo uglifyjs unzip upx-ucl vim \
            wget xmlto xxd zlib1g-dev zstd file

      - name: ðŸ“¦ Clone æºç 
        run: |
          git clone --depth 1 -b ${{ steps.config.outputs.branch }} \
            ${{ steps.config.outputs.repo }} immortalwrt
          cd immortalwrt
          echo "COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: ðŸ”„ ç¼“å­˜ DL ç›®å½•
        uses: actions/cache@v4
        with:
          path: immortalwrt/dl
          key: dl-${{ steps.config.outputs.target }}-${{ steps.config.outputs.branch }}-${{ hashFiles(format('devices/{0}.conf', matrix.device)) }}
          restore-keys: |
            dl-${{ steps.config.outputs.target }}-${{ steps.config.outputs.branch }}-
            dl-${{ steps.config.outputs.target }}-

      - name: ðŸ”„ ç¼“å­˜ Toolchain
        uses: actions/cache@v4
        with:
          path: |
            immortalwrt/staging_dir/host*
            immortalwrt/staging_dir/toolchain*
            immortalwrt/build_dir/host*
            immortalwrt/build_dir/toolchain*
          key: toolchain-${{ steps.config.outputs.target }}-${{ steps.config.outputs.subtarget }}-${{ env.COMMIT }}
          restore-keys: |
            toolchain-${{ steps.config.outputs.target }}-${{ steps.config.outputs.subtarget }}-

      - name: ðŸ“¡ æ›´æ–° Feeds
        run: |
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ðŸ“‚ æ³¨å…¥è‡ªå®šä¹‰æ–‡ä»¶ä¸Žè¡¥ä¸
        run: |
          cd immortalwrt
          # æ³¨å…¥ files/ï¼ˆuci-defaults ç­‰ï¼‰
          if [ -d "../files" ]; then
            cp -r ../files ./files
            echo "âœ… Custom files injected"
            find files/ -type f
          fi
          # ä¿®æ”¹é»˜è®¤ä¸»æœºåå’Œ LAN IP
          sed -i "s/hostname='ImmortalWrt'/hostname='OpenWRT'/" package/base-files/files/bin/config_generate
          sed -i "s/192\.168\.1\.1/192.168.3.1/g" package/base-files/files/bin/config_generate
          echo "âœ… Hostname=OpenWRT, LAN=192.168.3.1"

      - name: âš™ï¸ ç”Ÿæˆ .config
        run: |
          cd immortalwrt
          bash ../scripts/generate-config.sh ../devices/${{ matrix.device }}.conf

      - name: â¬‡ï¸ ä¸‹è½½ä¾èµ–åŒ…
        run: |
          cd immortalwrt
          make download -j16
          find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true

      - name: ðŸ”¨ ç¼–è¯‘å›ºä»¶
        run: |
          cd immortalwrt
          echo "CPU: $(nproc) cores"
          echo "RAM: $(free -h | awk '/^Mem:/{print $2}')"
          echo "Swap: $(free -h | awk '/^Swap:/{print $2}')"
          df -h /
          make -j$(nproc) || make -j1 V=s

      - name: ðŸ“¦ æ•´ç†å›ºä»¶
        run: |
          cd immortalwrt
          bash ../scripts/post-build.sh ${{ matrix.device }}
          echo "ðŸ“¦ Output files:"
          ls -lh ../output/${{ matrix.device }}/ 2>/dev/null || echo "No output!"

      - name: ðŸ“¤ ä¸Šä¼ å›ºä»¶ Artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.device }}
          path: output/${{ matrix.device }}/
          if-no-files-found: warn

  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    if: success()
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ“¥ ä¸‹è½½æ‰€æœ‰å›ºä»¶
        uses: actions/download-artifact@v4
        with:
          path: firmware/
          pattern: firmware-*

      - name: ðŸ“‹ æ£€æŸ¥ä¸‹è½½å†…å®¹
        run: |
          echo "=== Downloaded artifacts ==="
          find firmware/ -type f | sort
          echo "==="
          du -sh firmware/*/ 2>/dev/null || echo "No firmware dirs"

      - name: ðŸ“‹ ç”Ÿæˆ Release Notes
        run: |
          DATE="${{ needs.prepare.outputs.date }}"
          BUILD_TIME="$(date -u +'%Y-%m-%d %H:%M UTC')"

          {
            echo "## OpenWRT è‡ªå®šä¹‰å›ºä»¶"
            echo ""
            echo "### ðŸ“¦ åŒ…å«è®¾å¤‡"

            for dir in firmware/firmware-*/; do
              if [ -f "${dir}info.txt" ]; then
                cat "${dir}info.txt"
              fi
            done

            echo ""
            echo "### ðŸ”Œ ä¸»è¦æ’ä»¶"
            echo "- **ä»£ç†**: HomeProxy + Passwall (sing-box å…¨ç‰¹æ€§: QUIC/Reality/WireGuard/uTLS/gVisor)"
            echo "- **ä¸»é¢˜**: Argon + å…¨ä¸­æ–‡ç•Œé¢"
            echo "- **å·¥å…·**: ddns-go / ttyd / frpc / netdata / tcpdump"
            echo "- **å†…æ ¸**: nft-tproxy / nft-fullcone / tun"
            echo ""
            echo "### ðŸ’¡ åˆ·æœºè¯´æ˜Ž"
            echo "- **x86**: è§£åŽ‹ img.gz åŽå†™å…¥ç£ç›˜æˆ–å¯¼å…¥è™šæ‹Ÿæœº"
            echo "- **ARM è®¾å¤‡**: \`sysupgrade -n firmware.itb\`ï¼ˆä¸ä¿ç•™é…ç½®ï¼‰"
            echo "- é»˜è®¤ç®¡ç†åœ°å€: \`192.168.3.1\`"
            echo "- é»˜è®¤ä¸»æœºå: \`OpenWRT\`"
            echo "- é»˜è®¤å¯†ç : æ— ï¼ˆé¦–æ¬¡ç™»å½•è®¾ç½®ï¼‰"
            echo "- é»˜è®¤æ—¶åŒº: Asia/Shanghai"
            echo ""
            echo "### â„¹ï¸ ç¼–è¯‘ä¿¡æ¯"
            echo "- æºç : ImmortalWrt"
            echo "- ç¼–è¯‘æ—¶é—´: ${BUILD_TIME}"
            echo "- Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          } > release_notes.md

          echo "=== Release Notes ==="
          cat release_notes.md

      - name: ðŸš€ åˆ›å»º Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.date }}-${{ github.run_number }}
          name: "OpenWRT Firmware v${{ needs.prepare.outputs.date }}"
          body_path: release_notes.md
          files: |
            firmware/**/*.img.gz
            firmware/**/*.itb
            firmware/**/*.bin
            firmware/**/*.fip
            firmware/**/*.manifest
            firmware/**/*.buildinfo
            firmware/**/sha256sums.txt
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
